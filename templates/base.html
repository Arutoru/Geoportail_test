<!DOCTYPE html>
{% load static %}
{% load leaflet_tags %}
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    {% leaflet_js %}
    {% leaflet_css %}
    <!-- Load static css -->
    <link rel="stylesheet" href="{% static "css/style.css" %}"/>
    <script type="text/javascript" src="{% static "routing/leaflet-routing-machine.js" %}"></script>
    <link rel="stylesheet" href="{% static "routing/leaflet-routing-machine.css" %}"/>
    <!-- Load Esri Leaflet Geocoder from CDN -->
    <link rel="stylesheet" href="https://unpkg.com/esri-leaflet-geocoder@2.3.2/dist/esri-leaflet-geocoder.css"
      integrity="sha512-IM3Hs+feyi40yZhDH6kV8vQMg4Fh20s9OzInIIAc4nx7aMYMfo+IenRUekoYsHZqGkREUgx0VvlEsgm7nCDW9g=="
      crossorigin="">
    <!-- Load Esri Leaflet from CDN -->
    <script src="https://unpkg.com/esri-leaflet@2.3.2/dist/esri-leaflet.js"
    integrity="sha512-6LVib9wGnqVKIClCduEwsCub7iauLXpwrd5njR2J507m3A2a4HXJDLMiSZzjcksag3UluIfuW1KzuWVI5n/cuQ=="
    crossorigin=""></script>
    <script src="https://unpkg.com/esri-leaflet-geocoder@2.3.2/dist/esri-leaflet-geocoder.js"
      integrity="sha512-8twnXcrOGP3WfMvjB0jS5pNigFuIWj4ALwWEgxhZ+mxvjF5/FBPVd5uAxqT8dd2kUmTVK9+yQJ4CmTmSg/sXAQ=="
      crossorigin=""></script>
    <!-- Latest compiled Bootsrtap -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css"
    integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <!-- Alternative to Bootstrap 3 Glyphicons -->
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">

    <title>Our home</title>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light d-flex justify-content-center">
      {% if user.is_authenticated and user.is_staff %}
        <ul class="d-flex flex-row navbar-nav mr-auto">
          <li><a class="navbar-brand" href="{% url 'home' %}">GEOSPACE</a></li>
          <li><a class="btn btn-primary" href="{% url 'admin:index' %}">Admin</a></li>
        </ul>
      {% elif user.is_authenticated %}
        <ul class="navbar-nav mr-auto">
          <li><a class="navbar-brand" href="{% url 'home' %}">GEOSPACE</a></li>
        </ul>
        <button type="button" id="dwn-btn" class="btn btn-success mx-2"> Télécharger les données</button>
      {% else %}
        <ul class="navbar-nav mr-auto">
          <li><a class="navbar-brand" href="{% url 'home' %}">GEOSPACE</a></li>
          <li><a class=" my-2 my-sm-0" href="{% url 'login' %}" aria-label="Login">
            <span class="fa fa-user fa-2x" aria-hidden="true"></span>
          </a></li>
        </ul>
      {% endif %}
      <div class="dropdown">
        <a class="btn btn-info dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            Liste des projets
        </a>
        <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
          <a class="dropdown-item active" href="#">PROJECT TOPIC 1</a>
          <a class="dropdown-item" href="#">PROJECT TOPIC 2</a>
          <a class="dropdown-item" href="#">PROJECT TOPIC 3</a>
        </div>
      </div>
    </nav>

    {% block content %}
    {% endblock %}
    <section class="d-flex flex-column flex-lg-row container-fluid">

      {% block content1 %}
      {% endblock %}

   </section>
  </body>

  <footer>
    <p> <b>Réalisé par </b><a href="https://www.linkedin.com/in/arthur-tankwa-1774bb170/" target = "_blank">Arthur Tankwa</a></p>
  </footer>

  {# Plugins#}
  <!-- Latest compiled and minified jQuery -->
  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
  <!-- Latest compiled and minified JavaScript -->
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
  <script type="text/javascript" src="{% static 'js/map.js' %}"></script>

  <script type="text/javascript">
    // On définit une boucle qui parcourera une liste contenant les fichiers json
    var dataurls = ['{% url "region_data" %}','{% url "borne_data" %}'] ;
    var files = new Array();
    window.addEventListener("map:init", function (event) {
      for (var i=0, c=dataurls.length; i<c; i++){
        //Définition des variables globales
        var dataurl = dataurls[i];
        var map = event.detail.map;
        var lc = map.layerscontrol;
        var control;
        var content;
        // Téléchargement des fichiers GEOJSON avec Ajax
        var file = fetch(dataurl).then(function(resp) {
            return resp.json();
          });
        files.push(file);
        // Définition de la symbologie pour les régions
        function colors(feature){
          var props = feature.properties;
          if (props.model == "reporter.region"){
            // console.log(new Date()-new Date(props.date));
            switch(new Date(props.date)-new Date()<0){
              case true:
                return{
                  color: 'red',
                  fillOpacity: 0.4
                };
              case false:
                if(new Date(props.date)-new Date()<10368000000){
                  return{
                    color: 'orange',
                    fillOpacity: 0.4
                  };
                }
                else{
                  return{
                    color: 'green',
                    fillOpacity: 0.4
                  };
              }
            };
        }};
        // Définition de la symbologie pour les marqueurs
        function markers(feature, latlng){
          var props = feature.properties;
          var greenIcon = L.icon({
            iconUrl: "http://static.arcgis.com/images/Symbols/NPS/npsPictograph_0231b.png",
            shadowUrl: "http://static.arcgis.com/images/Symbols/NPS/npsPictograph_0231b.png",

            iconSize:     [10, 10], // size of the icon
            shadowSize:   [10, 10], // size of the shadow
            iconAnchor:   [0, 0], // point of the icon which will correspond to marker's location
            shadowAnchor: [0, 0],  // the same for the shadow
            popupAnchor:  [-3, -76] // point from which the popup should open relative to the iconAnchor
          });
          if (props.model == "reporter.borne"){
                  return L.marker(latlng, {icon: greenIcon});
            }
        };

        // Définiton des popups et affichage des couches
        file.then(
        function(data) {
          lc.addOverlay(L.geoJson(data, {pointToLayer : markers, style: colors,
            onEachFeature: function onEachFeature(feature, layer) {
              var props = feature.properties;
              if (props.model == "reporter.region"){
                control = `<h7>Region<h7>`;
                content = `<h2 class = "popup">${props.nom}</h2><h3>${props.superficie} km²</h3><p>Date: ${props.date}</p>`};
              if (props.model == "reporter.borne"){
                control = `<h7>Borne <h7><img width="10" src="http://static.arcgis.com/images/Symbols/NPS/npsPictograph_0231b.png"/>`;
                content = `<img width="300" src="${props.picture_url}"/><h3 class = "popup">${props.name}</h3><p>Coord UTM: ${props.east},${props.nord}</p>`};
              layer.bindPopup(content);
          }}).addTo(map),control);
        });
      }});

      function map_init(map, options) {
        // Bar de recherche esri
        var searchControl = L.esri.Geocoding.geosearch().addTo(map);
        var results = L.layerGroup().addTo(map);

        searchControl.on('results', function (data) {
          var position = data.results[0].latlng;
          results.clearLayers();

          //Calcul d'itinéraire
          var routing = L.Routing.control({
            waypoints: [
              L.latLng(position.lat,position.lng),
              L.latLng(position.lat,position.lng)
            ]
          }).addTo(map);
          map.on("dblclick", function(e){
            routing.remove();
          });
          // document.getElementById("dwn-btn2").addEventListener("click", function(){
          //   routing.remove();
          // }, false);
        });
      };


      // function updateDiv(){
      //   $(document).ready(function(){
      //     $("#map").load(window.location.href + " #map" );
      //   });
      // };

  </script>

</html>
